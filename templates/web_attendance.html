<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafebasabasi - Absensi Wajah</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --coffee-dark: #3C2415;
            --coffee-medium: #8B4513;
            --coffee-light: #D2691E;
            --cream: #F5DEB3;
            --warm-white: #FDF6E3;
            --accent-gold: #DAA520;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, var(--warm-white) 0%, var(--cream) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .attendance-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(60, 36, 21, 0.15);
            width: 100%;
            max-width: 1100px;
            overflow: hidden;
        }

        .attendance-header {
            background: linear-gradient(135deg, var(--coffee-dark), var(--coffee-medium));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-brand i { font-size: 2rem; }
        .header-brand h1 { font-size: 1.5rem; margin: 0; }
        .header-brand small { font-size: 0.8rem; opacity: 0.8; }

        .header-time { text-align: right; }
        .header-time .time { font-size: 2rem; font-weight: 700; }
        .header-time .date { font-size: 0.9rem; opacity: 0.9; }

        .attendance-body {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            min-height: 500px;
        }

        .camera-section {
            background: #1a1a1a;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            min-height: 500px;
        }

        .camera-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }

        .face-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 220px; height: 280px;
            border: 3px dashed rgba(255, 255, 255, 0.6);
            border-radius: 50% 50% 45% 45%;
        }

        .camera-status-badge {
            position: absolute;
            bottom: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-status-badge .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: blink 1s infinite;
        }

        .camera-status-badge.offline .dot {
            background: #dc3545;
            animation: none;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #canvasElement { display: none; }

        .control-section {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .mode-tab {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #f0f0f0;
            color: #666;
        }

        .mode-tab.active.tab-masuk {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .mode-tab.active.tab-pulang {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .mode-tab:hover:not(.active) { background: #e0e0e0; }

        .instructions-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            flex: 1;
        }

        .instructions-card h4 {
            color: var(--coffee-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .instructions-card ul {
            list-style: none;
            padding: 0; margin: 0;
        }

        .instructions-card li {
            padding: 8px 0;
            color: #555;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9rem;
        }

        .instructions-card li i {
            color: var(--coffee-medium);
            margin-top: 2px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-camera {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--coffee-medium);
            background: white;
            color: var(--coffee-medium);
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .btn-camera:hover {
            background: var(--coffee-medium);
            color: white;
        }

        .status-area {
            margin-bottom: 20px;
            min-height: 50px;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 500;
            text-align: center;
        }

        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-info { background: #d1ecf1; color: #0c5460; }

        .btn-attendance {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 14px;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: auto;
        }

        .btn-attendance.btn-masuk {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-attendance.btn-pulang {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }

        .btn-attendance:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .btn-attendance:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            z-index: 10;
        }

        .loading-overlay.show { display: flex; }

        .loading-overlay .spinner-border {
            width: 3rem; height: 3rem;
            margin-bottom: 15px;
        }

        .back-link {
            text-align: center;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .back-link a {
            color: var(--coffee-medium);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }

        .back-link a:hover { color: var(--coffee-dark); }

        /* Success Modal */
        .success-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .success-modal-overlay.show { display: flex; }

        .success-modal {
            background: white;
            border-radius: 25px;
            padding: 50px 40px;
            text-align: center;
            max-width: 420px;
            width: 90%;
            animation: modalSlide 0.4s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.8) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .success-icon {
            width: 100px; height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            animation: successPulse 1.5s infinite;
        }

        .success-icon.masuk { background: linear-gradient(135deg, #28a745, #20c997); }
        .success-icon.pulang { background: linear-gradient(135deg, #dc3545, #fd7e14); }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .success-icon i { font-size: 50px; color: white; }

        .success-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 10px; }
        .success-title.masuk { color: #28a745; }
        .success-title.pulang { color: #dc3545; }

        .success-message { color: #666; margin-bottom: 20px; }

        .success-time {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--coffee-dark);
            margin-bottom: 20px;
        }

        .success-employee {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .success-employee .name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--coffee-dark);
        }

        .success-countdown { color: #888; font-size: 0.9rem; }

        .security-warning {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .security-warning h5 { color: #856404; margin-bottom: 10px; font-size: 0.95rem; }
        .security-warning p, .security-warning li { color: #856404; font-size: 0.85rem; margin: 0; }

        @media (max-width: 900px) {
            .attendance-body { grid-template-columns: 1fr; }
            #videoElement { min-height: 350px; }
            .attendance-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .header-time { text-align: center; }
        }

        @media (max-width: 500px) {
            body { padding: 10px; }
            .attendance-container { border-radius: 16px; }
            .control-section { padding: 20px; }
            .mode-tab { padding: 12px 8px; font-size: 0.9rem; }
            .btn-attendance { padding: 16px; font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Success Modal -->
    <div class="success-modal-overlay" id="successModal">
        <div class="success-modal">
            <div class="success-icon" id="successIcon">
                <i class="bi bi-check-lg"></i>
            </div>
            <h2 class="success-title" id="successTitle">ABSEN BERHASIL!</h2>
            <p class="success-message" id="successMessage">Absensi telah tercatat</p>
            <div class="success-time" id="successTime">--:--:--</div>
            <div class="success-employee">
                <div class="name" id="successEmployee">-</div>
            </div>
            <p class="success-countdown">Kembali dalam <span id="countdown">5</span> detik...</p>
        </div>
    </div>

    <div class="attendance-container">
        <div class="attendance-header">
            <div class="header-brand">
                <i class="bi bi-cup-hot"></i>
                <div>
                    <h1>Kafebasabasi</h1>
                    <small>Sistem Absensi Karyawan</small>
                </div>
            </div>
            <div class="header-time">
                <div class="time" id="currentTime">--:--:--</div>
                <div class="date" id="currentDate">Memuat...</div>
            </div>
        </div>

        <div class="attendance-body">
            <div class="camera-section">
                <video id="videoElement" autoplay playsinline muted></video>
                <div class="camera-overlay">
                    <div class="face-guide"></div>
                </div>
                <div class="camera-status-badge offline" id="cameraStatusBadge">
                    <span class="dot"></span>
                    <span id="cameraStatus">Kamera tidak aktif</span>
                </div>
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner-border text-light" role="status"></div>
                    <p>Memproses absensi...</p>
                </div>
            </div>
            <canvas id="canvasElement"></canvas>

            <div class="control-section">
                <div class="mode-tabs">
                    <button class="mode-tab tab-masuk active" id="tabMasuk" onclick="switchMode('masuk')">
                        <i class="bi bi-box-arrow-in-right"></i> Absen Masuk
                    </button>
                    <button class="mode-tab tab-pulang" id="tabPulang" onclick="switchMode('pulang')">
                        <i class="bi bi-box-arrow-left"></i> Absen Pulang
                    </button>
                </div>

                <div class="camera-controls">
                    <button class="btn-camera" id="startCamera">
                        <i class="bi bi-camera-video"></i> Aktifkan
                    </button>
                    <button class="btn-camera" id="switchCamera" style="display: none;">
                        <i class="bi bi-arrow-repeat"></i> Ganti
                    </button>
                    <button class="btn-camera" id="stopCamera" style="display: none;">
                        <i class="bi bi-camera-video-off"></i> Matikan
                    </button>
                </div>

                <div class="security-warning" id="securityWarning">
                    <h5><i class="bi bi-exclamation-triangle"></i> Peringatan Keamanan</h5>
                    <p>Akses kamera diblokir. Buka via: <a href="#" id="localhostLink">localhost:5001</a></p>
                </div>

                <div class="status-area" id="statusArea"></div>

                <div class="instructions-card">
                    <h4><i class="bi bi-info-circle"></i> Petunjuk</h4>
                    <ul>
                        <li><i class="bi bi-check-circle"></i> Aktifkan kamera dan posisikan wajah di kotak</li>
                        <li><i class="bi bi-check-circle"></i> Pastikan pencahayaan cukup</li>
                        <li><i class="bi bi-check-circle"></i> Pilih mode absen (Masuk/Pulang)</li>
                        <li><i class="bi bi-check-circle"></i> Klik tombol untuk absen</li>
                    </ul>
                </div>

                <button id="btnAttendance" class="btn-attendance btn-masuk" disabled>
                    <i class="bi bi-box-arrow-in-right" id="btnIcon"></i>
                    <span id="btnText">ABSEN MASUK</span>
                </button>
            </div>
        </div>

        <div class="back-link">
            <a href="/auth"><i class="bi bi-arrow-left"></i> Kembali ke Halaman QR</a>
        </div>
    </div>

    <script>
        let currentMode = 'masuk';
        let stream = null;
        let isProcessing = false;
        let currentFacingMode = 'user';

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');

        document.addEventListener('DOMContentLoaded', () => {
            updateTime();
            setInterval(updateTime, 1000);
            checkSecurityContext();
            setTimeout(startCamera, 500);

            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('switchCamera').addEventListener('click', switchCameraFn);
            document.getElementById('stopCamera').addEventListener('click', stopCamera);
            document.getElementById('btnAttendance').addEventListener('click', markAttendance);
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tabMasuk').classList.toggle('active', mode === 'masuk');
            document.getElementById('tabPulang').classList.toggle('active', mode === 'pulang');
            
            const btn = document.getElementById('btnAttendance');
            btn.classList.remove('btn-masuk', 'btn-pulang');
            btn.classList.add('btn-' + mode);
            
            document.getElementById('btnIcon').className = mode === 'masuk' ? 'bi bi-box-arrow-in-right' : 'bi bi-box-arrow-left';
            document.getElementById('btnText').textContent = mode === 'masuk' ? 'ABSEN MASUK' : 'ABSEN PULANG';
        }

        function checkSecurityContext() {
            const hostname = window.location.hostname;
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            const isHTTPS = window.location.protocol === 'https:';

            if (!isLocalhost && !isHTTPS) {
                const warning = document.getElementById('securityWarning');
                const link = document.getElementById('localhostLink');
                warning.style.display = 'block';
                link.href = 'http://localhost:5001' + window.location.pathname;
                link.textContent = 'http://localhost:5001' + window.location.pathname;
            }
        }

        async function startCamera() {
            try {
                showStatus('Mengaktifkan kamera...', 'info');
                
                const constraints = {
                    video: { facingMode: currentFacingMode, width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                };

                document.getElementById('btnAttendance').disabled = false;
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('switchCamera').style.display = 'flex';
                document.getElementById('stopCamera').style.display = 'flex';
                
                const badge = document.getElementById('cameraStatusBadge');
                badge.classList.remove('offline');
                document.getElementById('cameraStatus').textContent = 'Kamera aktif';
                
                showStatus('Kamera aktif! Posisikan wajah di kotak.', 'success');

            } catch (error) {
                console.error('Camera error:', error);
                let msg = 'Gagal mengakses kamera. ';
                if (error.name === 'NotAllowedError') msg += 'Izinkan akses kamera di browser.';
                else if (error.name === 'NotFoundError') msg += 'Kamera tidak ditemukan.';
                else msg += error.message;
                showStatus(msg, 'error');
            }
        }

        function switchCameraFn() {
            if (stream) {
                stopCamera();
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                setTimeout(startCamera, 500);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                
                document.getElementById('btnAttendance').disabled = true;
                document.getElementById('startCamera').style.display = 'flex';
                document.getElementById('switchCamera').style.display = 'none';
                document.getElementById('stopCamera').style.display = 'none';
                
                const badge = document.getElementById('cameraStatusBadge');
                badge.classList.add('offline');
                document.getElementById('cameraStatus').textContent = 'Kamera tidak aktif';
            }
        }

        function captureImage() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        async function markAttendance() {
            if (isProcessing || !stream) return;

            try {
                isProcessing = true;
                document.getElementById('loadingOverlay').classList.add('show');
                document.getElementById('btnAttendance').disabled = true;

                const imageData = captureImage();
                const formData = new FormData();
                formData.append('mode', currentMode);
                formData.append('image_data', imageData);
                formData.append('source', 'web');

                const response = await fetch('/mark_attendance_mobile', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    let employeeName = result.employee_name || 'Karyawan';
                    if (!result.employee_name && result.message) {
                        const match = result.message.match(/untuk\s+(.+?)(?:\s+pada|$)/i);
                        if (match) employeeName = match[1];
                    }
                    showSuccessPopup(currentMode, employeeName);
                } else {
                    showStatus('❌ ' + result.message, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus('❌ Terjadi kesalahan. Coba lagi.', 'error');
            } finally {
                isProcessing = false;
                document.getElementById('loadingOverlay').classList.remove('show');
                if (stream) document.getElementById('btnAttendance').disabled = false;
            }
        }

        function showStatus(message, type) {
            const area = document.getElementById('statusArea');
            area.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function showSuccessPopup(mode, employeeName) {
            const modal = document.getElementById('successModal');
            const icon = document.getElementById('successIcon');
            const title = document.getElementById('successTitle');
            
            icon.classList.remove('masuk', 'pulang');
            icon.classList.add(mode);
            title.classList.remove('masuk', 'pulang');
            title.classList.add(mode);

            if (mode === 'masuk') {
                title.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> ABSEN MASUK BERHASIL!';
                document.getElementById('successMessage').textContent = 'Selamat bekerja! Absensi masuk tercatat.';
            } else {
                title.innerHTML = '<i class="bi bi-box-arrow-left"></i> ABSEN PULANG BERHASIL!';
                document.getElementById('successMessage').textContent = 'Terima kasih! Absensi pulang tercatat.';
            }

            document.getElementById('successTime').textContent = new Date().toLocaleTimeString('id-ID');
            document.getElementById('successEmployee').textContent = employeeName;
            
            modal.classList.add('show');

            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            let countdown = 5;
            const countdownEl = document.getElementById('countdown');
            const interval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    window.location.href = '/auth';
                }
            }, 1000);
        }
    </script>
</body>
</html>
