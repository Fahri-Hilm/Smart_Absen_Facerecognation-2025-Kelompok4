<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Save Photos & Auto Training</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Test Save Photos & Auto Training</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üì∏ Capture Photos</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>Employee ID:</label>
                            <input type="number" id="employeeId" class="form-control" value="8" min="1">
                        </div>
                        
                        <div class="mb-3">
                            <video id="video" width="300" height="200" autoplay style="border: 1px solid #ccc;"></video>
                        </div>
                        
                        <div class="mb-3">
                            <button id="captureBtn" class="btn btn-primary">üì∑ Capture Photo</button>
                            <button id="clearBtn" class="btn btn-warning">üóëÔ∏è Clear All</button>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Photos captured: <span id="photoCount">0</span></strong>
                        </div>
                        
                        <canvas id="canvas" width="300" height="200" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üíæ Save & Training</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button id="saveBtn" class="btn btn-success btn-lg">
                                üíæ Save Photos & Auto Train
                            </button>
                        </div>
                        
                        <div id="status" class="alert" style="display: none;"></div>
                        
                        <div id="progress" class="progress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>üìã Instructions:</h6>
                            <ol>
                                <li>Set Employee ID</li>
                                <li>Capture minimal 5 photos</li>
                                <li>Click "Save Photos & Auto Train"</li>
                                <li>System akan save foto dan langsung training model</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üñºÔ∏è Captured Photos Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="photoPreview" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/save-photos-auto-train.js"></script>
    <script>
        let video, canvas, ctx;
        let capturedPhotos = [];

        // Initialize camera
        async function initCamera() {
            try {
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 300, height: 200 } 
                });
                video.srcObject = stream;
                
                console.log('‚úÖ Camera initialized');
            } catch (error) {
                console.error('‚ùå Camera error:', error);
                showStatus('Error accessing camera: ' + error.message, false);
            }
        }

        // Capture photo
        function capturePhoto() {
            if (!video.videoWidth) {
                showStatus('Camera not ready', false);
                return;
            }

            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get base64 data
            const base64Data = canvas.toDataURL('image/jpeg', 0.8);
            
            // Add to manager
            const employeeId = document.getElementById('employeeId').value;
            if (!employeeId) {
                showStatus('Please set Employee ID', false);
                return;
            }

            window.photoSaveManager.setEmployeeId(employeeId);
            
            if (window.photoSaveManager.addPhoto(base64Data)) {
                updatePhotoCount();
                addPhotoPreview(base64Data);
                showStatus(`Photo ${window.photoSaveManager.getPhotoCount()} captured!`, true);
            } else {
                showStatus('Maximum photos reached (50)', false);
            }
        }

        // Update photo count
        function updatePhotoCount() {
            document.getElementById('photoCount').textContent = window.photoSaveManager.getPhotoCount();
        }

        // Add photo preview
        function addPhotoPreview(base64Data) {
            const preview = document.getElementById('photoPreview');
            const img = document.createElement('img');
            img.src = base64Data;
            img.style.cssText = 'width: 60px; height: 40px; border: 1px solid #ccc; border-radius: 4px;';
            preview.appendChild(img);
        }

        // Clear all photos
        function clearPhotos() {
            window.photoSaveManager.clearPhotos();
            updatePhotoCount();
            document.getElementById('photoPreview').innerHTML = '';
            showStatus('All photos cleared', true);
        }

        // Save photos and train
        async function savePhotosAndTrain() {
            const saveBtn = document.getElementById('saveBtn');
            const progress = document.getElementById('progress');
            
            if (window.photoSaveManager.getPhotoCount() < 5) {
                showStatus('Minimal 5 photos required', false);
                return;
            }

            // Show progress
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Saving & Training...';
            progress.style.display = 'block';
            
            // Animate progress
            let progressValue = 0;
            const progressBar = progress.querySelector('.progress-bar');
            const progressInterval = setInterval(() => {
                progressValue += 10;
                progressBar.style.width = progressValue + '%';
                if (progressValue >= 90) {
                    clearInterval(progressInterval);
                }
            }, 200);

            try {
                const result = await window.photoSaveManager.savePhotosAndTrain();
                
                // Complete progress
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                showStatus(result.message, result.success);
                
                if (result.success) {
                    // Clear preview on success
                    document.getElementById('photoPreview').innerHTML = '';
                    updatePhotoCount();
                }
                
            } catch (error) {
                showStatus('Error: ' + error.message, false);
            } finally {
                // Reset UI
                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save Photos & Auto Train';
                    progress.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        // Show status message
        function showStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'}`;
            status.textContent = message;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initCamera();
            
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('clearBtn').addEventListener('click', clearPhotos);
            document.getElementById('saveBtn').addEventListener('click', savePhotosAndTrain);
            
            // Set initial employee ID
            window.photoSaveManager.setEmployeeId(document.getElementById('employeeId').value);
            
            document.getElementById('employeeId').addEventListener('change', (e) => {
                window.photoSaveManager.setEmployeeId(e.target.value);
            });
        });
    </script>
</body>
</html>
